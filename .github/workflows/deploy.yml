name: Build and Deploy to AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
  CONTAINER_NAME: react-app
  CONTAINER_PORT: "80:3000"

permissions:
  id-token: write   # Required for OIDC
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials (OIDC - No secrets!)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Generate version tag
      id: version
      run: |
        VERSION=$(date +%Y%m%d-%H%M%S)-${{ github.run_number }}-${GITHUB_SHA::7}
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "Building version: ${VERSION}"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ steps.version.outputs.VERSION }}
          ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false
        sbom: false

    - name: Deploy to EC2 via SSM
      env:
        FULL_IMAGE: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ steps.version.outputs.VERSION }}
        INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
      run: |
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "${INSTANCE_ID}" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "echo \"[INFO] Logging into ECR...\"",
            "aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}",
            "echo \"[INFO] Pulling new image: ${{ env.FULL_IMAGE }}\"",
            "docker pull ${{ env.FULL_IMAGE }}",
            "echo \"[INFO] Stopping old container...\"",
            "docker stop ${{ env.CONTAINER_NAME }} || true",
            "docker rm ${{ env.CONTAINER_NAME }} || true",
            "echo \"[INFO] Starting new container...\"",
            "docker run -d --name ${{ env.CONTAINER_NAME }} --restart unless-stopped -p ${{ env.CONTAINER_PORT }} ${{ env.FULL_IMAGE }}",
            "echo \"[INFO] Saving version info...\"",
            "mkdir -p /var/app",
            "echo ${{ steps.version.outputs.VERSION }} > /var/app/current-version.txt",
            "echo \"[INFO] Cleaning up old images...\"",
            "docker image prune -f",
            "echo \"[INFO] Deployment complete!\"",
            "docker ps | grep ${{ env.CONTAINER_NAME }}"
          ]' \
          --region ${{ env.AWS_REGION }} \
          --output text \
          --query 'Command.CommandId')
        
        echo "SSM Command ID: $COMMAND_ID"
        
        # Wait for command to complete
        echo "Waiting for deployment to complete..."
        sleep 15
        
        # Check command status
        STATUS=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "${INSTANCE_ID}" \
          --region ${{ env.AWS_REGION }} \
          --query 'Status' \
          --output text)
        
        echo "Deployment Status: $STATUS"
        
        if [ "$STATUS" != "Success" ]; then
          echo "Deployment failed! Getting logs..."
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${INSTANCE_ID}" \
            --region ${{ env.AWS_REGION }}
          exit 1
        fi

    - name: Verify deployment
      env:
        INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
      run: |
        echo "Verifying deployment..."
        aws ssm send-command \
          --instance-ids "${INSTANCE_ID}" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "docker ps | grep ${{ env.CONTAINER_NAME }}",
            "cat /var/app/current-version.txt"
          ]' \
          --region ${{ env.AWS_REGION }}

    - name: Deployment summary
      run: |
        echo "âœ… Deployment successful!"
        echo "Version: ${{ steps.version.outputs.VERSION }}"
        echo "Image: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ steps.version.outputs.VERSION }}"
